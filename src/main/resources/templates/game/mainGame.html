<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ç«‹æ–¹çš„ä¸€ç”Ÿ - 3D Cube Adventure</title>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        body { margin: 0; overflow: hidden; background-color: #000; }
        canvas { display: block; }
        #fullscreen-prompt {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(128, 128, 128, 0.3);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            text-align: center;
            font-family: Arial, sans-serif;
            z-index: 100;
            pointer-events: none;
            transition: opacity 0.5s;
            border: 1px solid rgba(128, 128, 128, 0.7);
        }
        #fullscreen-prompt.hidden {
            opacity: 0;
        }
        #click-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99;
            cursor: pointer;
        }
        /* æ§åˆ¶æç¤ºæ ·å¼ */
        .controls-hint {
            position: absolute;
            bottom: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-family: Arial, sans-serif;
            font-size: 0.9rem;
            z-index: 100;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        #camera-hint {
            left: 30%;
            transform: translateX(-50%);
        }
        #movement-hint {
            left: 70%;
            transform: translateX(-50%);
        }
        .controls-hint.hidden {
            opacity: 0;
        }
    </style>
</head>
<body>
<div id="fullscreen-prompt">ç‚¹å‡»ä»»æ„å¤„å¼€å¯æ˜Ÿé™…èˆªè¡Œæ¨¡å¼ï½</div>
<div id="click-overlay"></div>
<div id="camera-hint" class="controls-hint">é¼ æ ‡è½¬åŠ¨æœ›è¿œé•œğŸ”­</div>
<div id="movement-hint" class="controls-hint">>WSAD/æ–¹å‘é”®é©¾é©¶æ–¹å—é£èˆ¹ğŸš€</div>
<div id="minimap-container" style="position: absolute; top: 10px; left: 10px; width: 200px; height: 200px; border: 2px solid rgba(255,255,255,0.5); z-index: 100;">
    <canvas id="minimap" width="200" height="200"></canvas>
</div>
<div id="game-timer" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); color: #00bfff; font-size: 1.5rem; z-index: 100; text-shadow: 0 0 10px rgba(0, 191, 255, 0.7);">
    [[${remainingTime}]]
</div>

<script src="/game/js/three.js"></script>
<script th:inline="javascript">
    // ä»localStorageè·å–token
    const token = [[${token}]] || localStorage.getItem('authToken');
    if (!token) {
        console.log("æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œè¯·é‡æ–°ç™»å½•");
        // Tokenä¸å­˜åœ¨æ—¶ï¼Œå…ˆæ¸…é™¤å¯èƒ½çš„ç™»å½•çŠ¶æ€å†è·³è½¬
        fetch('/logout', { method: 'POST' })
            .finally(() => {
                setTimeout(() => window.location.href = '/', 2000);
            });
    }

    // ä»Thymeleafæ¨¡å‹è·å–å‚æ•°
    const cubeConfig = {
        position: {
            x: /*[[${cube?.position?.x != null ? cube.position.x : 0}]]*/ 0,
            y: /*[[${cube?.position?.y != null ? cube.position.y : 0}]]*/ 0,
            z: /*[[${cube?.position?.z != null ? cube.position.z : 0}]]*/ 0
        },
        color: /*[[${cube?.color != null ? cube.color : '#FFFFFF'}]]*/ '#FFFFFF',
        size: /*[[${cube?.size != null ? cube.size : 0}]]*/ 0,
        renderOrder: /*[[${cube?.renderOrder != null ? cube.renderOrder : 0}]]*/ 0
    };

    console.log("Cube Config: ", cubeConfig);
    const cameraConfig = {
        x: /*[[${cameraPosition?.x != null ? cameraPosition.x : 0}]]*/ 0,
        y: /*[[${cameraPosition?.y != null ? cameraPosition.y : 0}]]*/ 0,
        z: /*[[${cameraPosition?.z != null ? cameraPosition.z : 0}]]*/ 0
    };
    console.log("Camera Config: ", cameraConfig);
    const mapDataList = /*[[${mapDataList}]]*/ [];
    console.log("Map Data List: ", mapDataList);
    let userPropCubes = /*[[${userPropCubes}]]*/ [];
    console.log("Prop Cubes: ", userPropCubes);
</script>
<!--<script src="/game/js/three.js"></script>-->
<script src="/game/js/meteor.js" type="module"></script>
<script src="/game/js/three-init.js"></script>
<script src="/game/js/controls.js"></script>
<script src="/game/js/timecheck.js"></script>
<script src="/game/js/animation.js"></script>
<script src="/game/js/utils.js"></script>
<script src="/game/js/collision-detection.js"></script>

<script>
    // åˆå§‹åŒ–æ¸¸æˆ
    function initGame() {
        console.log("åˆå§‹åŒ–æ¸¸æˆ");
        resumeGame();
        // æ¨¡å—åŠ è½½å®Œæˆåå†è°ƒç”¨
        initThreeScene(cubeConfig, cameraConfig);
        setupControls();
        initTimeCheck();
        setupEventListeners();
        animate();
    }

    // å½“é¡µé¢æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆåè°ƒç”¨åˆå§‹åŒ–å‡½æ•°
    window.onload = function() {
        initGame();
    };

    function initPauseResumeListener() {
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                // é¡µé¢éšè—ï¼ˆç”¨æˆ·ç¦»å¼€æ¸¸æˆï¼‰ï¼Œæš‚åœè®¡æ—¶
                pauseGame();
            } else {
                // æ¢å¤è®¡æ—¶
                resumeGame();
            }
        });

        // ç›‘å¬é¡µé¢å…³é—­/åˆ·æ–°äº‹ä»¶ï¼ˆä½œä¸ºè¡¥å……ï¼‰
        window.addEventListener('beforeunload', () => {
            pauseGame();
        });
    }

    // æš‚åœæ¸¸æˆè¯·æ±‚
    function pauseGame() {
        if (!token) return;
        fetch('/api/game/pause', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        }).catch(error => console.error('æš‚åœæ¸¸æˆå¤±è´¥:', error));
    }

    // ç»§ç»­æ¸¸æˆè¯·æ±‚
    function resumeGame() {
        if (!token) return;
        fetch('/api/game/resume', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                // ç»§ç»­è®¡æ—¶åé‡æ–°åˆå§‹åŒ–æ—¶é—´æ£€æŸ¥
                initTimeCheck();
            }
        }).catch(error => console.error('ç»§ç»­æ¸¸æˆå¤±è´¥:', error));
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç›‘å¬
    initPauseResumeListener();
</script>
</body>
</html>